# 背包系统

代码相关：
- gamex/models/bag/**.go
- gamex/models/gamedata__items.go

背包中所有物品都有唯一的数字ID(uint32)标识。

背包中的所有数据都用数据结构BagItem表达。请参考item.go


背包系统分为两类物品

 - 固定数字ID物品 (0-0x8000000) 不包含0和0x8000000
 - 非固定数字ID物品 [0x8000000, 0xFFFFFFFF]

0为预留ID。数字0的BagItem物品用来保存背包额外系统信息。
 
 - BagItem.ID 为非固定数字ID物品的自增长计数器
 - TODO

## 固定数字ID物品

游戏服务器读取数据表Items.xlsx，然后根据物品ItemID字符串生成唯一数字ID.
所以：
 
 - 读取玩家背包后，需要更新背包中固定数字ID物品的BagItem.ID值。因为数据表可能有变化。

## 非固定数字ID物品

这种物品的默认行为是：即使ItemID是一样的，在背包中也保留多份，占用多个背包格子。
有点类似堆叠上限是1，超出堆叠后不丢弃的物品。

为什么会有非固定数字ID的物品? 直接修改物品的堆叠上线为1，超堆行为为不丢弃，不可以吗？
因为比如武器，武器有额外属性，而及时是ItemID相同，但是额外属性确可能不同。因此无法用堆叠表示。此外武器的掉落对额外属性的随机数量是很多的。

因为非固定数字ID物品，通常可以用于不堆叠，数量多，有额外随机属性的物品。

## 数据库保存

BagItem列表序列化到bag:{profileid}的Hash中。Key是BagItem.ID，Value是BagItem的json序列化。

其中元素0 的BagItem保存背包的额外其他信息。

## API接口设计

背包接收的几种操作和相关系统（需要持续更新）

- 客户端
  - EQUIP/UNEQUIP ID
  - SELL ID Count
- 服务器系统
  - 合成 Has ItemID Count 
  - 使用 Use ItemID Count
  - 添加 Add ItemID Count

需要和背包交互的系统包括：

- 关卡结算/战斗结算/任务结算
- 合成/进化
- 各种奖励/邮件/兑换码
- 商场购买
- 装备系统
- ...

## 有关堆叠/背包格子的处理（固定ID物品）

如果有材料M 97个，但是M的堆叠上限是99. 行为是不丢弃。

当我们添加5个M到背包时。背包的BagItem.Space会是2，表示占用两个格子。BagItem.Count则是102。

需要更新背包的格子总数量的情况：

- 每次添加删除Item后
- 每次重新读取背包数据到内存后

客户端需要根据Space的值决定如何显示背包。


