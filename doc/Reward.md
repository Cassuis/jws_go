# 奖励系统

## 1. 综述

玩家可以通过一个奖励来领取固定的道具、体力、金钱
一个奖励只能领取一次，但可以重复生成
奖励的领取是有条件的
部分奖励可能需要自动领取
奖励的生成途径很多，有固定的，也有不固定的（邮件奖励）
奖励分散在各个系统，一般有如下：
- 每日奖励，每天玩家都可以领取固定的几种奖励
- 成就奖励，只生成一次，玩家达成条件即可领取
- 任务奖励，同成就奖励，额外的任务奖励的生成依赖与其他任务奖励或其他玩家属性
- 邮件奖励，非固定生成，个别玩家专属的奖励，通过邮件生成
- 补偿奖励，非固定生成，通过邮件生成，玩家登陆自动领取
- 兑换码奖励，玩家输入一个兑换码，从而生成一个奖励

可以通过奖励不同的行为对其进行分类：
- 领取方式：自动领取奖励与手动领取奖励
- 生成方式：固定生成、条件生成、时间生成、邮件生成与兑换码生成

| 奖励类别   | 领取方式 | 生成方式           | 
| ------ | ---- | -------------- | 
| 每日奖励   | 手动   | 时间生成（每日）       | 
| 成就奖励   | 手动   | 条件生成（接近成就条件？）  | 
| 任务奖励   | 手动   | 条件生成（前置奖励已领取？） | 
| 邮件奖励   | 手动   | 邮件生成           | 
| 补偿奖励   | 自动？  | 邮件生成           | 
| 兑换码奖励  | 自动？  | 兑换码生成          | 
| 全员补偿奖励 | 手动   | 固定生成           | 

### 1.1 领取方式

#### 1.1.1 自动领取

自动领取即奖励生成之后，直接将奖励结果发送给玩家
#### 1.1.2 手动领取

手动领取即奖励生成之后，需要客户端主动发送领取奖励的请求，如果可领，才将奖励结果发送给玩家
### 1.2 生成方式

生成方式是指如何给玩家一个奖励，
生成给一个玩家的奖励之后，玩家可以看到这个奖励，如果满足奖励领取条件，就可以领取奖励
#### 1.2.1 固定生成

对任何玩家只要这个奖励类型没有领取过且没有生成过，就生成
#### 1.2.2 时间生成

对任何玩家若这个奖励类型当天（可能还有周奖励）没有生成过，就生成
#### 1.2.3 条件生成

对任何玩家若满足一个条件，这个奖励类型没有领取过且没有生成过，就生成
#### 1.2.4 邮件生成

读取邮件时，每一个奖励邮件生成对应的奖励
#### 1.2.5 兑换生成奖励

玩家输入兑换码之后，生成一个兑换码对应的奖励
### 1.3 奖励状态

奖励有如下状态
- 是否激活
- 是否可见
- 是否可领取
- 是否已领取

当奖励在有效时间段中是，即视为激活状态，
在更新奖励列表时可以只生成对玩家可见的奖励，
是否可领取要根据奖励所有的条件来判断，
是否已领取可以通过一个已领取的奖励类型id列表来判断。
### 1.4 奖励领取条件

每个奖励类型都会对应一个领取条件，该条件满足的时候，玩家可以领取该奖励。
TODO 条件应该有个独立系统实现具体逻辑
### 1.5 奖励内容

奖励内容分两种用途，一种就是实实在在给玩家的奖励，分体力、货币、道具等，
另一种是用来在玩家领取之前作展示用的数据，
通常上来讲后一种内容可以根据前一种生成，但不排除有特殊情况，展示可能会很不一样。
所以设计上策划需要配置奖励参数的同时指定展示用的参数。
TODO 和策划确认表结构
### 1.6 奖励有效时间

奖励是需要一个有效时间段的，一旦超过这个时间范围，即使奖励已生成，也不可再领取（需要与策划确认），
这个设计另一方面可以减少可用奖励的个数，便于效率优化。
## 2. 设计

### 2.1 玩家奖励

玩家的奖励可以通过数组存储，每个奖励都有自己的奖励类型，通过这个类型实现具体逻辑，
当玩家领取奖励时，发送奖励的数组索引值即可。
### 2.2 奖励数据

### 2.3 玩家奖励更新逻辑

由于生成方式的不同，服务器需要在一些时刻遍历所有已激活奖励类型，
如果满足生成奖励条件，就生成一个奖励，
更新的时机需要注意，由于生成的条件受条件系统、玩家数据、时间影响，
所以**不仅**在玩家请求奖励相关逻辑时需要更新奖励，
在条件依据变化、玩家数据变化时也需要更新奖励。
比如
有一个每日任务是每天打三次副本，那么在玩家跨天时他可能没有触发任何奖励相关的操作，直接打了一次副本，
如果条件系统是针对每个奖励生成一个计数的话，那么这一次打副本就不会计入条件进度当中了。
另一方面，要考虑可领取奖励的通知（红点）功能，要实现这个功能肯定要预先更新奖励。
## 3. 实现细节

## 4. TODO