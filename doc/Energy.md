#体力系统
---------------------

## 体力系统特点

增长方式

- 随着时间自动增长，速率固定。
- 其他奖励增长方式
  - VIP 领取额外体力
  - 临时节日活动 登录奖励额外体力
  - 购买IAP等额外赠送
  - PVP等系统赠送

消耗方式：

- 进行Gameplay
- 扫荡

目前很多游戏中，只有自动随着时间增长的时候才会有上限设置。如果体力超出上限N，自动增长则停止。

状态：

- 体力溢出状态：可以超出上限，超出上限后，没有自动恢复。
- 未溢出状态：速率固定自动增长

影响参量

* 体力上限：玩家等级、VIP
* 体力购买次数上限：等级、VIP

离线恢复和计算方式

* 客户端自己在游戏进入后台时使用预测公式，生成local notification.
* 使用时做验证(包括登录，关卡结算)


##1. 综述
###1.1 值系统设计

值是玩家所有的一类特定的数值，这些数值会不依赖于玩家与系统行为自动变动，每个值都拥有一个最大值和一个最小值（一般为0），玩家会使用这些值，使用值不会超过最小值，另一方面，某些时候变动值时，也不会超过最大值。例如玩家体力，会随着时间增长，当然随时间增长时，体力并不会超过体力上限，当玩家使用这些值时需要先确认变动，再使用。

####1.1.1.变动

变动分被动变动和主动变动，被动变动是指值自动的增长或减少，并不是由于玩家与系统的行为，例如随时间增长的体力，随时间减少的CD时间(这个似乎单独一个系统比较好),相应的，主动变动是指由玩家与系统行为发起的增长或减少，例如玩家手动领取奖励，或者是系统补偿玩家。

####1.1.2.被动变动

被动变动现阶段需要的有两种：

- 基于时间变动：即每隔一定时间增加或减少某固定值，例如玩家体力，每6秒增加1点（只是举例）
- 基于时刻变动：即经过某一个固定时间周期内的某些特定时刻，值增加或减少，例如游戏刀塔传奇中玩家每天免费领奖次数，每天的0:00点回复为最大值，又如活动，每周一三五零点活动A次数增加为最大值，B次数减为0，每周二四六零点B次数增加为最大值，A次数减为0，周日零点AB次数均增加至最大值。

####1.1.3.主动变动

主动变动会有很多原因，归纳起来有如下：

- Add 增加，不会超过值的最大值。
- AddForce 强制增加，可以超过值的最大值。
- Add2Max 回复为最大，如果值已经大于等于最大值，则不处理。
- Use 使用值V点，会返回是否使用成功。
- Has 值当前是否大于V点。

###1.2 体力系统实现
基于值系统，只需实现基于时刻变动即可，需要把下次增长时刻发送给客户端模拟体力增长

##2. 设计

###2.1 体力值存储

需要存储的值有体力值、体力上次更新时刻，玩家需要体力值时以这两个变量更新即可，
为了便于计算将时刻存储为unix时间戳。

###2.2 更新算法

	                 + s +
	   ----+---------+---+---+--------
	      last     this now  next
	   ----+---------+---+---+--------
	       +    add  +   + r +

	                 + one   +
	                 
以秒为单位，如图其中

- last : 上次更新时刻
- this : 本次更新时刻
- add  : 转为体力的时间长度
- now  : 现在时刻
- next : 下一次增加体力时刻 需要发给客户端帮助其模拟增长
- s    : 当前结算时间中不足一次体力加成的部分

这一部分保留，所以本次更新之后，上次更新时刻被指为this

- r    : 到下次增长剩余的时间
- one  : 一次增长所需的时间 如6分钟增长一点体力 one即为360

体力实际的增加值即为add/one，上次更新时间被置为this值

###2.3 体力最大值

目前体力最大值由战队等级决定。

##3. 实现细节
##4. TODO
