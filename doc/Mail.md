# 邮件系统



玩家在客户端界面看到的邮件系统，通常是一个列表。这个列表有一些二级分类：

1. 奖励：玩法产出奖励的领取
2. 信息：离线信息的保存(系统给玩家，玩家之间)
3. 功能：好友的申请，加入公会的申请

邮件系统通常有数量上限和时间上限。旧邮件的淘汰方式有：

- 邮件时间到达时间上限
- 邮件系统邮件数量到达上限，直接淘汰最旧邮件

每一封邮件都有重要优先级，当系统邮件数量到达上限时，根据优先级由低到高淘汰旧邮件。如果有低优先级的邮件存在则不会淘汰高一级的邮件。优先级按照1-100数字安排。1为最低优先级， 100为最高优先级

- 1： 信息类邮件
- 40：代表本组奖励最高只有白色装备
- 50：代表本组奖励最高有紫色装备
- 80：代表本组奖励最高有橙色装备
- 100：代表本组奖励除非领取永不删除

当邮件系统中因为达到邮件数量上限导致只能删除80级别以上的奖励时，应该锁死玩法强制玩家处理邮箱领取。

>  需要注意的是，因为自动删除某些奖励带来的客服需求。

## 邮件系统在游戏中的角色

**缓释上限**

在目前的设计中，邮件系统从用户体验上承载了缓释所有其他玩法可能会面对的*上限*处理，例如背包会达到上限。使得玩家都能够集中的在一个系统中管理各种来源的奖励。而不必为每一个玩法添加一个独立的*上限*处理流程。

**重要事物提醒**

随着玩法越来越多，很多功能需要玩家等待一定时间后才能看到结果（例如：种菜收菜）。而玩家再次回到游戏中可能忘记了（收菜）。我们往往通过邮件系统使得玩家能够知道**很久之前**种下的菜该收了。

作为公会高级成员，平时玩游戏的过程中，可能需要处理一些公会事物，例如批准新会员。

## 信件的来源

### 信件—信息分类

- 发送给玩家的请求回执
- 发送给玩家的公会公告
- GM给玩家的信息

其他分类也是信息类型邮件基础上的一个扩展。

操作删除方式：现在我们实现简单的信息分类的特点是阅后即焚。读取后关闭就自动删除了。也可以实现成下线后就自动删除，这样在线的时候玩家想重新看也是可以的。

### 信件—奖励分类

A - 在线行为产生: 由另外一个玩法产生的奖励。只有玩家在线的时候才会计算，只有玩家在线的时候才会领取。

B - 离线行为产生：玩家参加某些玩法活动(周竞技场)，活动在玩家不在线的时候生成的结算。该类奖励，通常在玩家再次登录时才真正计算成**信件**。

C - 系统产生：可能是玩家行为（购买IAP）等间接产生的奖励。通常是客服系统利用一个名单进行定向发奖或者全服发奖。因为是客服系统发放，因此次系统需要：能够方便的重发但是不重复(无论玩家是否已经收到邮箱中，是否已经领取等状态标记。都通过状态直接在存档中保留)。使得客服容易查询。

操作删除方式：奖励领取后立即删除

A的实现可以使用内存和S3映射。

B的实现是在玩家登录时计算成A能够使用的信件，然后立即标记状态。但是因为要保存处理后的状态，因此由两个S3文件组成，一个是系统计算结算发奖时写的奖励，另一个是玩家在线计算后标记状态使用

C的实现也是由两个S3文件的操作组成。类似B

### 信件—功能分类

通常能想到的功能型邮件主要是好友请求，公会请求等请求批准类功能。

#### 请求

请求的行为是异步的，请求的时候，接收者可能不在线。

此外在能够发送请求的时候，通常伴随着其他查询：

- 对方是否允许接收请求(黑名单)
- 是否已经发送过请求。

需要处理的复杂行为是，如何防止同样的请求邮件被多次接收到。如何设置黑名单不接收某个来源的请求。黑名单也需要控制尺寸。

操作删除方式：功能处理后删除

### 信件— 全服的广播

上面所有信件功能分类中都是**定向**发送到具体玩家的。这里考虑一下**全服**的信件广播问题。

- 全服公告邮件
- 全服补偿奖励

#### 全服公告邮件

如果每个玩家都需要拷贝一份内容到自己的邮箱是完全没有必要的存储浪费。

实现方式A：

- 全服公告邮件准备一个全局的列表，每个公告有自己的全局唯一ID
- 服务器定时去相关S3文件刷新到服务器内存。
- 玩家在刷新邮箱显示的过程中合并到返回列表中。
- 当玩家阅读后，服务器存档记录全局公告邮件的唯一ID为已读。

实现方式B：

- 全服公告邮件，在邮件系统中置顶显示，玩家阅读后并不会消失。
- 每次都是服务器从S3文件刷新到内存中，合并到玩家请求刷新邮件的列表中。
- 玩家阅读后并不隐藏。

方案B，好处是服务器不需要单独记录是否已读的存档。而这个邮件的存在时间完全取决我们什么时候删除相关S3的内容。方案B更像是在刷新给玩家的邮件列表时，去公告文件中抓了一个公告，然后合并成一封特殊邮件。

#### 全服补偿奖励

- 全局的奖励的邮件列表，每个邮件都拥有独立全局唯一ID。
- 服务器定时从指定S3文件刷新到内存。
- 玩家上线后，对比自己最后一次领取的位置，是否小于全局邮件列表总数。如果是，则有新的奖励，拷贝相关奖励内容到玩家自身的S3特殊文件中。[^copysize]
- 玩家S3全服奖励状态存档中
  - 独立记录是否已经领取过。领取后显示隐藏，标记状态为已经领取。
  - 为领取过的记录，通过邮件列表展示给玩家

[^copysize]: 因为这种拷贝，导致邮件相关的存储会变得很大，所以建议采用S3来保存每个玩家复制全局奖励后的状态信息。



### 玩家上线过程中加载邮件列表到内存

因为大量使用S3作为邮件的数据KV Backend，因此S3有可能因为某些原因不能够很快的及时返回，并生成邮件列表。当然如果为了考虑KV Backend的及时性，可以考虑更换成DynamoDB/SSDB。

所以在玩家登录游戏服务器过程中，实际上只看内存邮件列表是否存在，存在则发送给玩家。如果不存在也会立即返回空，但是会触发刷新相关S3数据的异步加载过程。等到客户端下次请求获取邮件列表的时候，就能够得到最新的列表了。

# 极无双的Mail

### DynamoDB不删除邮件的Case

1. GMTools 用了Sys标记取发邮件，因此目前GMTools的全局邮件发送都是不会真正删除的。
2. 支付过程中，定时retry确认支付是否成功的流程中，支付相关的记录是不删除的。

