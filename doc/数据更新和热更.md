# 数据更新和热更

数据更新在数据调试过程中使用频繁，建立方便的自动化工具能够提高效率。

- 热更数据: 部分游戏数据表名符合 hot命名前缀。相关逻辑需要特殊处理。
- 非热更数据: 必须进行服务器重启才能生效。只有在启动过程中才能加载的数据


## 热更数据 的原理

热更数据的方式是通过etcd下的键值。该键值统一称作：*上传版本号*

*上传版本号* 分为两种
1. *分服上传版本号*
2. *统一热更版数据上传版本号*

### 分服单独热更数据
例如，运维选择主键值是`/a5k`, 热更的处理流程如下：

1. 配置`/a5k/hotdata/1.9.0/{sid}/curr` 的值，该值代表了服务器当前分服将要使用的热更数据的*分服上传版本号*
2. GET请求gamex post address触发http请求`gamex/v1/hotupdatedata`作为热更信号（运维人员gmtools操作界面按钮可以触发）
3. gamex收到信号后， 根据etcd下的键值*上传版本号*，下载对应数据。
4. gamex下载完成后，开始主动加载hot前缀命名的相关数据。


### 所有分服统一热更数据

在主版本号下的键值`/a5k/hotdata/1.9.0/curr`为*统一热更版数据上传版本号*。

*分服上传版本号* 优先级高于 *统一热更版数据上传版本号*。

当 **没有** *分服上传版本号* 的时候，服务器检查是否存在*统一热更版数据上传版本号*，有则使用*统一热更版数据上传版本号*。 如果没有则使用服务器部署自带的数据。

## 注意事项

只要任何一个*上传版本号*存在，即使部署新的二进制版本，新的代码仍然会使用该版本号锁定的数据。

_开发和测试阶段_：

*分服上传版本号*存在时，部署新服的时候，需要删除改键值，否则新服务器仍然使用*分服上传版本号*中锁定的数据。因为开发和测试阶段部署频繁，因此这里尤其要注意。目前相关自动化部署会主动删除*分服上传版本号*的etcd键值。

_生产环境中_：

*分服上传版本号* 用于，

 - 渠道测试版本的数据锁定。
 - 新数据小规模上线的灰度测试（此处要注意是否影响到相关multiplay的结果），当测试完毕是，应当删除相关*分服上传版本号*键值而使用使用*统一热更版数据上传版本号*行全面更新数据。

```flow
st=>start: 启动
e=>end:>
cond1=>condition: /a5k/hotdata/1.9.0/{sid}/curr 
存在吗？ 
op1=>operation: 读取存在的etcd key作为*上传版本号*
cond2=>condition: /a5k/hotdata/1.9.0/curr 
存在吗？
op2=>operation: Read /a5k/hotdata/1.9.0/curr

sub1=>subroutine: Read data in binary release

st->cond1
cond1(yes, right)->op1->e
cond1(no)->cond2
cond2(yes, right)->op1->e
cond2(no)->sub1->e
```



## 数据强制推送

当数据热更流程生效后，如果触发服务器重新启动。服务器则会强制要求所有数据都读取*上传版本号*下载下来的完整数据。数据强制推送，目前设计是只在开发和测试阶段中， 方便数值策划调整数据平衡时使用。 

因为数据从Excel通过ProtoBuf的方式生成data文件时，使用了统一的`x/tool_prototagnumer`服务进行protobuffer的tag number稳定性和唯一性管理。该服务运行再10.0.1.31上。通常的添加列，删除修改无用列等行为不会引起协议解析的变化，不会导致protobuf的数据解析错误。但是仍然会有一些情况会导致数据的加载失败。


## 仍然会导致数据自动部署失败的行为

### 1 GameMode
的添加需要再服务器这边手动同步修改`CounterTypeCountMax` 常量所在模式。




















